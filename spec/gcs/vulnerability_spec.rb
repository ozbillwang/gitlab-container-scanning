RSpec.describe Gcs::Vulnerability do
  let(:params) do
    {
      'category' => 'container_scanning',
      'message' => '',
      'description' =>
        'In musl libc through 1.2.1, wcsnrtombs mishandles particular combinations of destination buffer size and source character limit, as demonstrated by an invalid write access (buffer overflow).',
      'cve' => 'CVE-2020-28928',
      'severity' => 'Unknown',
      'confidence' => 'Unknown',
      'solution' => 'Upgrade musl to 1.1.24-r10',
      'scanner' => { 'id' => 'trivy', 'name' => 'trivy' },
      'location' => {
        'dependency' => {
          'package' => { 'name' => 'musl' }, 'version' => '1.1.24-r8'
        },
        'operating_system' => 'Unknown',
        'image' => 'alpine:latest (alpine 3.12.0)'
      },
      'identifiers' => [
        {
          'type' => 'cve',
          'name' => 'CVE-2020-28928',
          'value' => 'CVE-2020-28928',
          'url' => ''
        }
      ],
      'links' => [
        { 'url' => 'http://www.openwall.com/lists/oss-security/2020/11/20/4' },
        { 'url' => 'https://musl.libc.org/releases.html' }
      ]
    }
  end

  it 'formats vulnerability to parsable format' do
    vulnerability = described_class.new(params)
    expect(vulnerability.to_hash).to match(
      {
        "id" => "6f8e11f91b910c97d6d01c82a49cd5d7adf4dc23",
        'category' => 'container_scanning',
        'message' => '',
        'description' =>
          'In musl libc through 1.2.1, wcsnrtombs mishandles particular combinations of destination buffer size and source character limit, as demonstrated by an invalid write access (buffer overflow).',
        'cve' => 'CVE-2020-28928',
        'severity' => 'Unknown',
        'confidence' => 'Unknown',
        'solution' => 'Upgrade musl to 1.1.24-r10',
        'scanner' => { 'id' => 'trivy', 'name' => 'trivy' },
        "location" => {"dependency"=>{"package"=>{"name"=>"musl"}, "version"=>"1.1.24-r8"}, "image"=>"alpine:latest", "operating_system"=>"alpine 3.12.0"},
        'identifiers' => [
          {
            'type' => 'cve',
            'name' => 'CVE-2020-28928',
            'value' => 'CVE-2020-28928',
            'url' => 'http://www.openwall.com/lists/oss-security/2020/11/20/4'
          }
        ],
        'links' => [
          {
            'url' => 'http://www.openwall.com/lists/oss-security/2020/11/20/4'
          },
          { 'url' => 'https://musl.libc.org/releases.html' }
        ]
      }
    )
  end
end
