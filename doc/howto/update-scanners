# How scanners are updated monthly
The pipeline `Check if scanners are outdated` [is scheduled to run every 11th of the month](https://gitlab.com/gitlab-org/security-products/dependencies/trivy-db-glad/-/pipeline_schedules)

It will generate an MR with the latest versions of Trivy or Grype if there are new versions available.

## Steps to update scanner
Make sure that the above pipeline has completed running first. If it succesfully completes and there are new scanner versions, you should be able to see new MRs created with title `"Update #{scanner} to version #{new_version}"`

1. Retrieve the image url from the pipeline job log: 
    - The job should have the title: **release > tag branch:[\<scanner>, Dockerfile]**
    - Look for the image url from the logs. It should look something like: `registry.gitlab.com/gitlab-org/security-products/analyzers/container-scanning/tmp/grype:193dca72bab3627976c62f4b6d3e7ccb438a7f5c `
2. Run a container scan using the image url
    
    You can use this [Container Scanning Test](https://gitlab.com/gitlab-org/govern/demos/container-scanning-test) repo to run a container scan.
    1. [Run a new pipeline](https://gitlab.com/gitlab-org/govern/demos/container-scanning-test/-/pipelines/new)
    2. Set a ci variable `CS_ANALYZER_IMAGE` with the `image url` obtained from step 1
    3. Check that the container scan completes without error.
    
3. Check the changelog of [Trivy](https://github.com/aquasecurity/trivy/releases) and [Grype](https://github.com/anchore/grype/releases) to see if there are any potential breaking change that might affect the code.

4. If all is good, merge both scanner MRs(If both scanners have new versions) 

5. Create a new tag based on the new version that should have been auto incremented.
    - The new version can be found in the [version.rb](https://gitlab.com/gitlab-org/security-products/analyzers/container-scanning/-/blob/master/lib/gcs/version.rb) file. 

6. A release pipeline would be triggered to release the new version.

# Scheduled pipeline configuration

The `Check if scanners are outdated` scheduled pipeline is executed to run automatic scanner updates. To run correctly, it needs the following CI/CD variables:

* `TRIGGER_SCANNER_UPDATE` - **true/false** - if set to **true**, it triggers scanner update during pipeline execution.
* `CS_REVIEWERS_GROUP_ID` - **integer** - a reviewer for the created MR will be picked from the group with this ID.

# Update scanner manually

To update a scanner to the latest version, run `bundle exec rake update_<scanner_name>` to create a branch with the updated
version, then push your changes and create a new MR. Example:
```bash
$ bundle exec rake update_trivy
Version has changed from 0.18.1 to 0.19.1
creating update-trivy-to-0.19.1-2021-07-19 branch
$ git push
```